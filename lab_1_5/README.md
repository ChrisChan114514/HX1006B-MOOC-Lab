# lab_1_5 - 带数码管显示的模M计数器

## 项目概述

本实验设计了一个功能完整的带数码管显示的模 M 计数器，支持异步复位、使能控制和模值动态设置功能，集成了频率输出和七段数码管译码功能，实现了计数结果的直观显示。

## Verilog程序设计

### 模块功能

`mcnt_test` 模块实现了一个带数码管显示的模 M 计数器，具有以下特性：

- **模 M 计数**：通过拨码开关动态设置模值 M，计数器从 0 循环计数到 M
- **异步复位**：低电平异步复位功能，优先级最高
- **使能控制**：通过 EN 信号控制计数器工作状态
- **动态模值设置**：通过 SW[3:0] 动态设置计数模值（1-16 对应 SW 值 0-15）
- **频率输出**：当计数值小于 M/2 时输出高电平，大于等于 M/2 时输出低电平；由于蜂鸣器电路采用 PNP 三极管驱动（低电平导通），因此计数后半周期蜂鸣器响，实现占空比 50% 的间歇发声
- **数码管扫描**：内部自动生成扫描时钟（取 q[15] 作为数码管切换时钟）
- **数码管显示**：集成七段数码管译码器，动态显示 32 位计数值的高 12 位（3 个十六进制数字）

### 功能实现机制

#### 模 M 计数器模块（mcnt）

- **计数范围**：0 到 M 循环计数
- **模值设置**：`m = {4'd0, SW, 1'b1, 23'd0}`，即 m = SW × 2^24，SW[3:0] 取值 0-15 对应模值 M = 0×2^24 到 15×2^24，控制计数器的循环周期
- **频率输出**：`q < m/2` 时 `fout=1`（高电平），`q >= m/2` 时 `fout=0`（低电平）；蜂鸣器电路为 PNP 三极管驱动，低电平导通发声，因此在计数后半周期（q >= m/2）蜂鸣器响

#### 计数器逻辑

计数器的工作遵循以下优先级逻辑：

1. **复位最高优先级**：`reset_n=0` 时，计数器异步清零（`q=0`）
2. **使能控制**：`en=1` 时，计数器才能工作
3. **模 M 计数**：`en=1` 时，计数器递增，当 `q < m` 时 `q=q+1`，否则 `q=0`
4. **频率输出**：根据计数值与 M/2 的比较生成分频信号，`q >= m/2` 时 `fout=0`（低电平）驱动蜂鸣器发声

#### 七段数码管显示（seg_disp）

- **扫描时钟**：使用 `q[15]` 作为数码管位选切换时钟
- **显示内容**：显示 32 位计数值 q 的高 12 位（q[31:28]、q[27:24]、q[23:20]）
- **显示格式**：共阳极数码管驱动（低电平点亮）
- **支持显示**：0-9 数字及 A-F 十六进制字符

### 端口说明

| 端口     | 方向   | 位宽 | 说明                                                |
| -------- | ------ | ---- | --------------------------------------------------- |
| CLK_50   | input  | 1    | 50MHz 系统时钟                                      |
| KEY[1:0] | input  | 2    | 按键输入 [en, reset_n]                              |
| SW[3:0]  | input  | 4    | 拨码开关，设置计数模值（0-15 对应模值 1-16 的高位） |
| SEL[7:0] | output | 8    | 数码管位选信号（选择显示哪一位数码管）              |
| DIG[7:0] | output | 8    | 数码管段选信号（7 段 + 1 小数点）                   |
| BEEP     | output | 1    | 蜂鸣器驱动信号（分频输出）                          |

## ModelSim(Verilog TB代码仿真)

本工程不涉及

## FPGA板子硬件实验

生成 `.sof` 配置文件，下载到 FPGA 开发板进行硬件验证。

### 引脚绑定

#### 输入信号

| 信号   | FPGA引脚 | 硬件元件 | 说明                        |
| ------ | -------- | -------- | --------------------------- |
| CLK_50 | P11      | 50MHz    | 系统时钟（板载晶振）        |
| KEY[1] | E1       | KEY2     | 使能信号（按下为低电平）    |
| KEY[0] | M1       | KEY1     | 复位信号（按下为低电平）    |
| SW[3]  | M2       | SW4      | 模值设置位3（拨上为高电平） |
| SW[2]  | M15      | SW3      | 模值设置位2（拨上为高电平） |
| SW[1]  | M16      | SW2      | 模值设置位1（拨上为高电平） |
| SW[0]  | E16      | SW1      | 模值设置位0（拨上为高电平） |

#### 输出信号

| 信号   | FPGA引脚 | 硬件元件 | 说明                                     |
| ------ | -------- | -------- | ---------------------------------------- |
| SEL[0] | C9       | DIG1_SEL | 数码管位选（第1位，低电平选中）          |
| SEL[1] | D9       | DIG2_SEL | 数码管位选（第2位，低电平选中）          |
| SEL[2] | E11      | DIG3_SEL | 数码管位选（第3位，低电平选中）          |
| SEL[3] | F11      | DIG4_SEL | 数码管位选（第4位，低电平选中）          |
| SEL[4] | C11      | DIG5_SEL | 数码管位选（第5位，低电平选中）          |
| SEL[5] | D11      | DIG6_SEL | 数码管位选（第6位，低电平选中）          |
| SEL[6] | E14      | DIG7_SEL | 数码管位选（第7位，低电平选中）          |
| SEL[7] | F14      | DIG8_SEL | 数码管位选（第8位，低电平选中）          |
| DIG[0] | C14      | SEG_A    | 数码管段选 a（低电平点亮）               |
| DIG[1] | D14      | SEG_B    | 数码管段选 b（低电平点亮）               |
| DIG[2] | E10      | SEG_C    | 数码管段选 c（低电平点亮）               |
| DIG[3] | F10      | SEG_D    | 数码管段选 d（低电平点亮）               |
| DIG[4] | C15      | SEG_E    | 数码管段选 e（低电平点亮）               |
| DIG[5] | D15      | SEG_F    | 数码管段选 f（低电平点亮）               |
| DIG[6] | F9       | SEG_G    | 数码管段选 g（低电平点亮）               |
| DIG[7] | E9       | SEG_DP   | 数码管小数点（低电平点亮）               |
| BEEP   | B6       | BEEP     | 蜂鸣器驱动（低电平发声，PNP 三极管驱动） |

### 硬件测试步骤

1. **初始化**

   - 按下 KEY1（reset_n），复位计数器
   - 数码管应显示 000（计数值为 0）
   - 蜂鸣器无声（fout=1 高电平，PNP 三极管截止）
2. **正常计数测试**

   - 设置 SW[3:0] = 0000（模值对应最小值）
   - 松开 KEY1（reset_n=1）
   - 松开 KEY2（en=1）使能计数
   - 观察数码管显示计数值不断递增
   - 当计数值 q < m/2 时蜂鸣器不响，q >= m/2 时蜂鸣器响，形成间歇发声
3. **模值设置测试**

   - 设置不同的 SW[3:0] 组合，改变计数模值
   - 例如：SW[3:0] = 0001，对应 m = {4'd0, 4'd1, 1'b1, 23'd0}
   - 观察计数器达到模值后重新从 0 开始计数
   - 蜂鸣器频率随模值变化而改变（模值越大，周期越长，频率越低）
4. **频率输出观察**

   - 调整 SW[3:0] 的值
   - 当模值较小时，蜂鸣器响-停切换快
   - 当模值较大时，蜂鸣器响-停切换慢
   - 每个计数周期内，前半周期（0 到 m/2-1）蜂鸣器不响，后半周期（m/2 到 m-1）蜂鸣器响
5. **使能控制测试**

   - 松开 KEY2（en=0）禁止计数
   - 观察数码管显示保持不变
   - 蜂鸣器保持当前状态
   - 再次按下 KEY2（en=1），计数继续

ChrisChan
2025/10/27
