# lab_3_3 - VGA 卡通动画显示控制器

## 项目概述

本实验设计了一个基于 VGA 时序的卡通动画显示系统，实现了 640×480@60Hz 的 VGA 显示输出。系统通过 ROM 存储精灵图（512×128 像素）和调色板数据，在 VGA 显示屏幕上显示背景场景和可控制的卡通人物。卡通人物可通过按键控制左右移动，并自动播放行走动画（6帧循环），背景包含天空、云朵、草地和砖块地面。

## Verilog程序设计

### 整体架构

本项目由四个主要模块组成：

1. **vga_cartoon（顶层模块）**：PLL时钟管理，例化所有子模块
2. **vga_disp（显示控制模块）**：VGA 时序生成和图像显示控制
3. **rom_rgb（图像数据模块）**：存储精灵图和背景数据，处理调色板映射
4. **cartoon_ctr（动画控制模块）**：处理按键输入，控制卡通人物的位置、方向和动作

### 模块功能

#### vga_cartoon（顶层模块）

- **PLL时钟生成**：将 50MHz 系统时钟通过 PLL 生成 25MHz VGA 像素时钟
- **模块例化**：实例化 PLL、ROM、VGA 显示控制模块和动画控制模块
- **信号连接**：连接各模块间的数据总线和控制信号
- **按键输入**：接收2个按键信号，用于控制卡通人物移动方向

#### vga_disp（显示控制模块）

- **VGA 时序生成**：生成符合 640×480@60Hz 标准的行同步和场同步信号
- **显示区域**：在屏幕中央显示 512×128 像素的图像区域
- **坐标生成**：根据当前像素坐标生成相对坐标 x 和 y
- **场同步标志**：生成场同步脉冲标志信号，用于同步动画更新
- **RGB输出**：将 12 位 RGB 数据输出到 VGA 接口

#### rom_rgb（图像数据模块）

- **精灵图存储**：存储 256×64 像素的精灵图数据（6帧行走动画，每帧32×64像素）
- **调色板存储**：存储 64 色调色板（12 位 RGB）
- **背景生成**：根据坐标动态生成背景图案（天空、云朵、草地、砖块）
- **精灵渲染**：根据 position、action、orientation 参数渲染卡通人物
- **透明处理**：精灵图索引为0时显示背景，实现透明效果
- **镜像翻转**：根据 orientation 控制精灵水平翻转

#### cartoon_ctr（动画控制模块）

- **方向控制**：根据按键 key[1:0] 控制卡通人物朝向（左/右）
- **位置移动**：每 20ms（500,000 时钟周期）移动 1 像素
- **移动范围**：限制在 0~479 像素范围内
- **动作切换**：每移动 16 像素（320ms）切换一个动作帧
- **动作循环**：6 帧行走动画循环播放（action: 0~5）
- **场同步更新**：在场同步信号时更新 position 和 action 输出

### 功能实现机制

#### VGA 时序生成

- **像素时钟**：25MHz（由 PLL 从 50MHz 系统时钟生成）
- **水平时序**：总计 800 个时钟周期
  - 显示区：640 像素
  - 前肩：8 像素
  - 同步脉冲：96 像素
  - 后肩：56 像素
- **垂直时序**：总计 525 行
  - 显示区：480 行
  - 前肩：8 行
  - 同步脉冲：2 行
  - 后肩：35 行

#### 同步信号生成

- **行同步信号（HSYNC）**：在水平计数 656~751（640+8+8 到 640+8+8+95）期间为低电平
- **场同步信号（VSYNC）**：在垂直计数 490~491（480+8+2 到 480+8+2+1）期间为低电平
- **同步极性**：负极性同步（同步期间为低电平）
- **场同步脉冲**：通过 vs 与 vs_delay 异或生成单时钟脉冲，用于同步动画更新

#### 卡通动画显示

- **显示尺寸**：512×128 像素显示区域
- **显示位置**：屏幕中央，起始坐标 x=(640-512)/2=64，y=(480-128)/2=176
- **精灵尺寸**：32×64 像素卡通人物
- **精灵位置**：由 position（0~479）控制水平位置，垂直位置固定在 y=32
- **动画帧数**：6 帧行走动画（action: 0~5）
- **朝向控制**：orientation=0 朝左，orientation=1 朝右
- **镜像实现**：朝左时对精灵图 x 坐标取反（~x_shift[4:0]）

#### 背景渲染系统

背景通过分块映射实现，使用 {y[6:5], x[8:5]} 作为块索引：

- **蓝天（BLUESKY=0x7）**：默认背景
- **云朵（CLOUD=0x6）**：位于块 0x02 和 0x08
- **草地（GRASS=0xe）**：位于块 0x26 和 0x29
- **砖块地面（BRICK2=0xf）**：位于块 0x30~0x3f（底部区域）

每个背景块使用 32×32 像素纹理块，从精灵图 ROM 的对应区域读取。

#### 调色板系统

- **调色板容量**：64 色（6 位索引）
- **颜色深度**：12 位 RGB（每通道 4 位）
- **数据文件**：walk_pal.mem（64×12bit）
- **索引映射**：精灵图和背景图均存储 6 位调色板索引
- **透明处理**：索引 0 表示透明，显示背景而非精灵

#### 精灵图存储结构

- **总容量**：16384 字（256×64 像素）
- **数据格式**：6 位调色板索引
- **存储布局**：
  - 行走动画：6 帧 × 32×64 像素
  - 背景纹理：多个 32×32 像素块
- **数据文件**：walk.mem
- **地址编码**：
  - 精灵：{y[5:0], action[2:0], x[4:0]}
  - 背景：{background[3], y[4:0], background[2:0], x[4:0]}

#### 按键控制逻辑

- **方向控制**：
  - key[1]=1：向右移动（orientation=1）
  - key[0]=1：向左移动（orientation=0）
- **移动速度**：每按住 20ms（500,000 时钟周期）移动 1 像素
- **移动范围**：position 限制在 0~479 范围内
- **动作更新**：每移动 16 像素切换一帧动画
- **动作循环**：action 从 0 循环到 5（6 帧动画）

### 端口说明

#### vga_cartoon（顶层模块）

| 端口        | 方向   | 位宽 | 说明                                       |
| ----------- | ------ | ---- | ------------------------------------------ |
| clk50M      | input  | 1    | 50MHz 系统时钟                             |
| reset_n     | input  | 1    | 异步复位信号（低电平有效）                 |
| key[1:0]    | input  | 2    | 按键输入（key[1]=右，key[0]=左）           |
| VGA_HSYNC   | output | 1    | VGA 行同步信号（负极性）                   |
| VGA_VSYNC   | output | 1    | VGA 场同步信号（负极性）                   |
| VGA_D[11:0] | output | 12   | VGA RGB 颜色数据（R[3:0], G[3:0], B[3:0]） |

#### vga_disp（VGA显示模块）

| 端口        | 方向   | 位宽 | 说明                         |
| ----------- | ------ | ---- | ---------------------------- |
| clk25M      | input  | 1    | 25MHz 像素时钟               |
| reset_n     | input  | 1    | 异步复位信号（低电平有效）   |
| rgb[11:0]   | input  | 12   | 12 位 RGB 颜色数据           |
| VGA_HSYNC   | output | 1    | VGA 行同步信号               |
| VGA_VSYNC   | output | 1    | VGA 场同步信号               |
| vs_flag     | output | 1    | 场同步脉冲标志（单时钟脉冲） |
| x[10:0]     | output | 11   | 显示区域相对 x 坐标（0~511） |
| y[10:0]     | output | 11   | 显示区域相对 y 坐标（0~127） |
| VGA_D[11:0] | output | 12   | VGA RGB 颜色输出             |

#### rom_rgb（图像数据模块）

| 端口          | 方向   | 位宽 | 说明                       |
| ------------- | ------ | ---- | -------------------------- |
| clk           | input  | 1    | 系统时钟（25MHz）          |
| reset_n       | input  | 1    | 异步复位信号（低电平有效） |
| x[10:0]       | input  | 11   | 当前像素 x 坐标            |
| y[10:0]       | input  | 11   | 当前像素 y 坐标            |
| position[8:0] | input  | 9    | 卡通人物水平位置（0~479）  |
| action[2:0]   | input  | 3    | 动作帧编号（0~5）          |
| orientation   | input  | 1    | 朝向（0=左，1=右）         |
| rgb[11:0]     | output | 12   | 12 位 RGB 颜色输出         |

#### cartoon_ctr（动画控制模块）

| 端口          | 方向   | 位宽 | 说明                       |
| ------------- | ------ | ---- | -------------------------- |
| clk           | input  | 1    | 系统时钟（25MHz）          |
| reset_n       | input  | 1    | 异步复位信号（低电平有效） |
| key[1:0]      | input  | 2    | 按键输入（控制移动方向）   |
| vs_flag       | input  | 1    | 场同步脉冲标志             |
| orientation   | output | 1    | 朝向控制（0=左，1=右）     |
| position[8:0] | output | 9    | 卡通人物位置（0~479）      |
| action[2:0]   | output | 3    | 动作帧编号（0~5）          |

## ModelSim(Verilog TB代码仿真)

本工程包含测试平台 `vga_cartoon_tb.v` 用于验证 VGA 卡通动画显示控制器的功能。

### 仿真环境配置

- **时间单位**：`timescale 1ns/1ps`（时间刻度 1ns，时间精度 1ps）
- **时钟频率**：50MHz（周期 20ns）
- **像素时钟**：25MHz（周期 40ns，由 PLL 生成）
- **仿真时长**：建议 20ms 以上（覆盖至少一帧完整的 VGA 显示周期）

### 测试激励

1. **时钟生成**：产生 50MHz 连续系统时钟信号
2. **复位序列**：
   - 初始时刻 reset_n=0，复位系统
   - 100ns 后释放复位（reset_n=1）
3. **按键模拟**：
   - 初始 key=2'b00（无按键）
   - 可在仿真过程中改变 key 值测试移动控制
   - key=2'b10：向右移动
   - key=2'b01：向左移动
4. **数据文件**：自动加载 walk.mem（精灵图）和 walk_pal.mem（调色板）
5. **运行测试**：仿真足够时间，观察完整的动画播放和移动控制

### 观察信号

- **VGA_HSYNC**：行同步脉冲周期 32μs（800×40ns），低电平宽度 3.84μs
- **VGA_VSYNC**：场同步脉冲周期 16.7ms（525 行），低电平宽度约 64μs
- **vs_flag**：场同步脉冲标志，每帧产生一个时钟周期的脉冲
- **position**：卡通人物位置，初始值 224，按键按下时改变
- **action**：动作帧编号，每移动 16 像素循环 0~5
- **orientation**：朝向标志，key[1] 按下时为 1（右），key[0] 按下时为 0（左）
- **VGA_D**：RGB 颜色输出，显示背景和卡通动画

### 仿真要点

- 验证 PLL 是否正确生成 25MHz 时钟
- 检查按键控制逻辑是否正确改变 position 和 orientation
- 确认动作帧切换是否按照预期循环（每 320ms 切换一帧）
- 观察精灵图镜像翻转功能（左右朝向切换）
- 验证背景渲染是否正确（天空、云朵、草地、砖块）
- 检查透明处理（精灵图索引 0 显示背景）

## FPGA板子硬件实验

生成 `.sof` 配置文件，下载到 FPGA 开发板进行硬件验证。

### 引脚绑定

#### 输入信号

| 信号    | FPGA引脚 | 硬件元件 | 说明                     |
| ------- | -------- | -------- | ------------------------ |
| clk50M  | E15      | 50MHz    | 系统时钟（板载晶振）     |
| reset_n | M1       | KEY0     | 复位信号（按下为低电平） |
| key[1]  | M2       | KEY1     | 向右移动（按下为低电平） |
| key[0]  | N1       | KEY2     | 向左移动（按下为低电平） |

#### 输出信号

| 信号      | FPGA引脚 | 硬件元件 | 说明               |
| --------- | -------- | -------- | ------------------ |
| VGA_HSYNC | P16      | VGA_HS   | VGA 行同步信号     |
| VGA_VSYNC | N15      | VGA_VS   | VGA 场同步信号     |
| VGA_D[11] | F15      | VGA_R3   | VGA 红色通道最高位 |
| VGA_D[10] | F16      | VGA_R2   | VGA 红色通道位2    |
| VGA_D[9]  | G15      | VGA_R1   | VGA 红色通道位1    |
| VGA_D[8]  | G16      | VGA_R0   | VGA 红色通道最低位 |
| VGA_D[7]  | J11      | VGA_G3   | VGA 绿色通道最高位 |
| VGA_D[6]  | J16      | VGA_G2   | VGA 绿色通道位2    |
| VGA_D[5]  | J15      | VGA_G1   | VGA 绿色通道位1    |
| VGA_D[4]  | K16      | VGA_G0   | VGA 绿色通道最低位 |
| VGA_D[3]  | K15      | VGA_B3   | VGA 蓝色通道最高位 |
| VGA_D[2]  | L16      | VGA_B2   | VGA 蓝色通道位2    |
| VGA_D[1]  | L15      | VGA_B1   | VGA 蓝色通道位1    |
| VGA_D[0]  | N16      | VGA_B0   | VGA 蓝色通道最低位 |

### 硬件测试步骤

1. **连接 VGA 显示器**

   - 使用 VGA 线缆连接 FPGA 开发板的 VGA 接口和显示器
   - 确保显示器支持 640×480@60Hz 分辨率
2. **下载配置文件**

   - 在 Quartus II 中编译工程，生成 `.sof` 文件
   - 使用 USB Blaster 或其他下载器将配置文件下载到 FPGA
3. **复位测试**

   - 按下 KEY0（reset_n=0）复位系统
   - 显示器应显示黑屏或无信号状态
   - 松开 KEY0（reset_n=1），系统开始正常工作
4. **显示效果观察**

   - 正常工作后，显示器应显示带背景的场景：
     - 上方：蓝天背景和白色云朵
     - 中间：卡通人物（初始位置在屏幕中央偏左）
     - 下方：绿色草地和砖块地面
   - 卡通人物自动播放行走动画（6 帧循环）
5. **按键控制测试**

   - **KEY1（向右移动）**：
     - 按下 KEY1，卡通人物朝右，向右移动
     - 移动速度：每 20ms 移动 1 像素
     - 到达右边界（position=479）时停止
   - **KEY2（向左移动）**：
     - 按下 KEY2，卡通人物朝左，向左移动
     - 移动速度：每 20ms 移动 1 像素
     - 到达左边界（position=0）时停止
   - **松开按键**：卡通人物停止移动，但动画继续播放
6. **动画效果观察**

   - 行走动画：6 帧循环播放，每 320ms（16 像素移动）切换一帧
   - 镜像翻转：朝向改变时，精灵图自动水平翻转
   - 透明处理：卡通人物背景透明，可以看到后面的场景
7. **时序验证**

   - 使用示波器或逻辑分析仪可以观测 VGA_HSYNC 和 VGA_VSYNC 信号
   - 行同步周期：约 32μs（800×40ns）
   - 场同步周期：约 16.7ms（525×32μs）
   - 刷新率：约 60Hz

### 注意事项

- **数据文件**：walk.mem 和 walk_pal.mem 必须存在于工程目录中
- **ROM 初始化**：Quartus 编译时会自动将 .mem 文件内容加载到 ROM
- **PLL 配置**：确保 PLL 正确配置为 50MHz 输入，25MHz 输出
- **按键极性**：开发板按键按下时为低电平，需要注意按键逻辑
- **显示范围**：卡通人物位置范围 0~479，超出范围会被限制

## 项目文件说明

| 文件名           | 类型         | 说明                                       |
| ---------------- | ------------ | ------------------------------------------ |
| vga_cartoon.v    | Verilog HDL  | 顶层模块，PLL 时钟管理和模块例化           |
| vga_disp.v       | Verilog HDL  | VGA 显示控制模块，时序生成和图像显示       |
| rom_rgb.v        | Verilog HDL  | 图像数据模块，精灵图和背景渲染             |
| cartoon_ctr.v    | Verilog HDL  | 动画控制模块，按键处理和位置/动作控制      |
| pll.v            | Verilog HDL  | PLL IP 核文件（自动生成）                  |
| pll.qip          | QIP 文件     | Quartus IP 文件，包含 PLL 配置信息         |
| walk.mem         | MEM 文件     | 精灵图数据（256×64 像素，6 位调色板索引） |
| walk_pal.mem     | MEM 文件     | 调色板数据（64 色，12 位 RGB）             |
| vga_cartoon_tb.v | Verilog HDL  | 测试平台文件，用于 ModelSim 仿真           |
| vga_cartoon.qpf  | Quartus 项目 | Quartus Prime 项目文件                     |
| vga_cartoon.qsf  | Quartus 设置 | 引脚分配和编译设置文件                     |
| vga_cartoon.tcl  | TCL 脚本     | Quartus 自动化脚本                         |
| db/              | 目录         | Quartus 数据库文件夹                       |

### 数据文件格式

#### walk.mem（精灵图数据）

- **文件格式**：十六进制文本文件
- **数据内容**：16384 行，每行 1 个十六进制数（6 位调色板索引）
- **存储结构**：
  - 前 12288 字：6 帧行走动画（每帧 32×64 = 2048 像素）
  - 后 4096 字：背景纹理块（多个 32×32 像素块）
- **索引含义**：0 表示透明，1~63 为调色板颜色索引

#### walk_pal.mem（调色板数据）

- **文件格式**：十六进制文本文件
- **数据内容**：64 行，每行 1 个 12 位十六进制数（RGB 颜色）
- **颜色格式**：{R[3:0], G[3:0], B[3:0]}
- **示例**：
  - 0x000：黑色（透明）
  - 0xF00：红色
  - 0x0F0：绿色
  - 0x00F：蓝色
  - 0xFFF：白色

## 技术特点

### 1. 调色板技术

- 使用 6 位调色板索引存储图像，节省存储空间（相比直接存储 12 位 RGB）
- 支持 64 种颜色，满足卡通风格显示需求
- 调色板可灵活修改，无需重新生成精灵图数据

### 2. 精灵图技术

- 多帧动画存储在同一 ROM 中，通过 action 参数选择帧
- 透明处理：索引 0 自动显示背景，实现精灵与背景融合
- 镜像翻转：通过地址位翻转实现水平镜像，无需额外存储

### 3. 背景渲染

- 块映射技术：将 640×480 屏幕划分为 32×32 像素块
- 纹理复用：多个块可使用相同纹理，节省存储空间
- 动态生成：背景通过组合逻辑实时计算，无需额外存储

### 4. 动画控制

- 速度控制：通过计数器控制移动速度和动画帧率
- 边界检测：自动限制移动范围，防止越界
- 场同步更新：在场同步时更新位置和动作，避免画面撕裂

### 5. 时钟域管理

- PLL 时钟生成：从 50MHz 系统时钟生成 25MHz 像素时钟
- 单时钟域设计：所有模块使用同一时钟，避免跨时钟域问题
- 同步设计：所有输出在场同步时更新，确保画面稳定

ChrisChan
2025/10/28
