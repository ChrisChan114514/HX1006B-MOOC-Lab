# lab_3_3 - HDMI 卡通动画显示控制器

## 项目概述

本实验设计了一个基于 HDMI/DVI 协议的卡通动画显示控制器，实现了 1280×720@60Hz 的高清显示输出，采用 TMDS 差分信号传输，能够在屏幕上显示可交互控制的卡通角色动画，具有行走动画、方向控制和背景显示功能。

## Verilog程序设计

### 系统架构

HDMI 显示系统由以下核心模块组成：

1. **hdmi_colorbar_top**：顶层模块，集成时钟管理和各子模块
2. **pll_clk**：PLL 时钟生成模块，产生 74.25MHz 像素时钟和 371.25MHz 串行时钟
3. **video_driver**：视频时序驱动模块，生成 1280×720@60Hz 时序信号
4. **video_display**：视频显示模块，集成卡通动画显示逻辑  （**本次实验重点修改的文件**）
5. **cartoon_ctr**：卡通角色控制器，处理按键输入和角色移动逻辑  （**新增模块**）
6. **rom_rgb**：图像数据ROM模块，存储精灵图和背景数据  （**新增模块**）
7. **dvi_transmitter_top**：DVI/HDMI 传输顶层模块
8. **dvi_encoder**：DVI 编码器，执行 TMDS 8b/10b 编码
9. **serializer_10_to_1**：10:1 并串转换器，使用 DDR 输出技术
10. **asyn_rst_syn**：异步复位同步化模块

### video_display 模块功能

`video_display` 模块是应用层显示逻辑模块，负责生成显示内容，具有以下特性：

- **分辨率支持**：1280×720 像素（720p）
- **颜色深度**：24 位 RGB888 全彩色输出
- **显示内容**：卡通角色动画 + 背景场景
- **交互控制**：通过按键控制角色左右移动
- **动画系统**：6 种行走动作自动切换
- **图像缩放**：支持 2 倍缩放显示（从 640×360 逻辑坐标到 1280×720 物理分辨率）

### cartoon_ctr 模块功能

`cartoon_ctr` 卡通角色控制器模块负责游戏逻辑，具有以下特性：

- **按键控制**：
  - key[0]：控制角色向左移动
  - key[1]：控制角色向右移动
- **移动速度**：每 500,000 个时钟周期移动 1 像素（约 20ms）
- **位置范围**：0 ~ 1216 像素（适配 1280 宽度，角色宽度 64 像素）
- **动作切换**：每 16 次移动切换一个动作（共 6 种行走动作）
- **方向记忆**：记录并保持角色朝向（左/右）

### rom_rgb 模块功能

`rom_rgb` 图像数据 ROM 模块负责图像渲染，具有以下特性：

- **精灵图存储**：256×64×6 位数据（6 种动作 × 32×64 像素）
- **调色板系统**：64 色调色板（12 位 RGB444）
- **背景系统**：蓝天、白云、草地、砖块平台
- **坐标缩放**：自动将 1280×720 缩放到 640×360 逻辑坐标
- **RGB 扩展**：将 12 位 RGB444 扩展为 24 位 RGB888
- **镜像翻转**：支持角色水平镜像（实现左右朝向）

### 功能实现机制

#### 时钟生成

- **系统输入时钟**：50MHz
- **PLL 输出**：
  - 像素时钟：74.25MHz（用于 720p@60Hz 时序）
  - 串行时钟：371.25MHz（5 倍像素时钟，用于 TMDS 串行化）

#### 720p 视频时序

- **像素时钟**：74.25MHz
- **水平时序**：总计 1650 个时钟周期
  - 显示区：1280 像素
  - 前肩：110 像素
  - 同步脉冲：40 像素
  - 后肩：220 像素
- **垂直时序**：总计 750 行
  - 显示区：720 行
  - 前肩：5 行
  - 同步脉冲：5 行
  - 后肩：20 行
- **帧率**：60Hz（74.25MHz ÷ 1650 ÷ 750 ≈ 60Hz）

#### 卡通动画显示算法

`video_display` 模块集成了卡通动画系统，通过实例化 `cartoon_ctr` 和 `rom_rgb` 模块实现：

```verilog
// 实例化卡通控制器
cartoon_ctr u_cartoon_ctr(
    .clk        (pixel_clk),
    .reset_n    (sys_rst_n),
    .key        (key),
    .vs_flag    (vs_flag),
    .orientation(orientation),
    .position   (position),
    .action     (action)
);

// 实例化ROM RGB模块
rom_rgb u_rom_rgb(
    .clk        (pixel_clk),
    .reset_n    (sys_rst_n),
    .x          (pixel_xpos),
    .y          (pixel_ypos),
    .position   (position),
    .action     (action),
    .orientation(orientation),
    .rgb        (pixel_data)
);
```

**显示层次**：
1. **背景层**：使用背景 ROM 数据绘制蓝天、云朵、草地、砖块
2. **精灵层**：在 position 位置绘制 32×64 像素的角色精灵
3. **坐标缩放**：将 1280×720 物理坐标通过右移 1 位缩放到 640×360 逻辑坐标
4. **颜色扩展**：12 位 RGB444 通过位复制扩展为 24 位 RGB888

**动作控制流程**：
1. 按键输入 → cartoon_ctr 处理
2. 移动计数器达到阈值 → 更新位置
3. 动作计数器达到阈值 → 切换动作帧
4. 场同步信号 → 更新显示坐标
5. rom_rgb 根据坐标和动作索引查表 → 输出像素颜色

#### TMDS 编码与传输

- **编码方式**：8b/10b TMDS 编码（直流平衡编码）
- **通道数量**：3 个数据通道（R、G、B）+ 1 个时钟通道
- **差分信号**：每个通道使用差分对传输（P/N）
- **串行化**：使用 DDR 技术实现 10:1 并串转换

### 端口说明

#### hdmi_colorbar_top 顶层模块

| 端口           | 方向   | 位宽 | 说明                              |
| -------------- | ------ | ---- | --------------------------------- |
| sys_clk        | input  | 1    | 50MHz 系统时钟                    |
| sys_rst_n      | input  | 1    | 系统复位信号（低电平有效）        |
| key[1:0]       | input  | 2    | 按键输入（控制角色移动）          |
| tmds_clk_p     | output | 1    | TMDS 时钟差分信号正端             |
| tmds_clk_n     | output | 1    | TMDS 时钟差分信号负端             |
| tmds_data_p[2] | output | 1    | TMDS 数据通道 2 差分信号正端（R） |
| tmds_data_n[2] | output | 1    | TMDS 数据通道 2 差分信号负端（R） |
| tmds_data_p[1] | output | 1    | TMDS 数据通道 1 差分信号正端（G） |
| tmds_data_n[1] | output | 1    | TMDS 数据通道 1 差分信号负端（G） |
| tmds_data_p[0] | output | 1    | TMDS 数据通道 0 差分信号正端（B） |
| tmds_data_n[0] | output | 1    | TMDS 数据通道 0 差分信号负端（B） |

#### video_display 应用层模块

| 端口           | 方向   | 位宽 | 说明                       |
| -------------- | ------ | ---- | -------------------------- |
| pixel_clk      | input  | 1    | 74.25MHz 像素时钟          |
| sys_rst_n      | input  | 1    | 系统复位信号（低电平有效） |
| key[1:0]       | input  | 2    | 按键输入（角色移动控制）   |
| vs_flag        | input  | 1    | 场同步标志脉冲             |
| pixel_xpos     | input  | 11   | 当前像素横坐标（0~1279）   |
| pixel_ypos     | input  | 11   | 当前像素纵坐标（0~719）    |
| pixel_data[23] | output | 24   | 像素颜色数据 RGB888 格式   |

## ModelSim 仿真验证

本工程包含完整的仿真测试平台 `tb_hdmi_colorbar_top.v`，用于验证 HDMI 卡通动画显示系统的功能。

### 仿真环境配置

- **时间单位**：`timescale 1ns/1ps`
- **系统时钟**：50MHz（周期 20ns）
- **像素时钟**：74.25MHz（由 PLL 生成）
- **串行时钟**：371.25MHz（由 PLL 生成）
- **仿真时长**：建议至少 30ms，覆盖 1~2 帧完整的显示周期

### 测试激励

1. **时钟生成**：产生 50MHz 连续系统时钟
2. **复位序列**：
   - 初始时刻 sys_rst_n=0，复位系统
   - 200ns 后释放复位（sys_rst_n=1）
3. **运行测试**：观察 TMDS 差分信号输出和时序

### 主要观察信号

- **video_hs/video_vs**：内部视频同步信号（720p 时序）
- **video_de**：数据使能信号（有效显示区域标识）
- **pixel_data**：24 位 RGB 像素数据，应呈现卡通角色和背景图像
- **position**：角色水平位置坐标
- **action**：当前动作帧索引（0~5）
- **orientation**：角色朝向（0=左，1=右）
- **tmds_data_p/n**：TMDS 差分数据信号
- **tmds_clk_p/n**：TMDS 差分时钟信号

### 时序参数验证

- **行周期**：约 22.2μs（1650 × 13.47ns）
- **场周期**：约 16.7ms（750 行 × 22.2μs）
- **帧率**：60Hz

## FPGA 硬件实验

在 Quartus 中综合并生成 `.sof` 配置文件，下载到 FPGA 开发板进行硬件验证。

### 引脚绑定

#### 输入信号

| 信号      | FPGA引脚 | 电气标准 | 说明                       |
| --------- | -------- | -------- | -------------------------- |
| sys_clk   | E15      | 3.3V     | 50MHz 系统时钟（板载晶振） |
| sys_rst_n | M1       | 3.3V     | 系统复位（KEY0 按键）      |
| key[0]    | F3       | 3.3V     | 角色向左移动控制按键       |
| key[1]    | E1       | 3.3V     | 角色向右移动控制按键       |

#### 输出信号（HDMI 接口）

| 信号           | FPGA引脚 | 电气标准  | 说明                     |
| -------------- | -------- | --------- | ------------------------ |
| tmds_clk_p     | G15      | LVDS 3.3V | HDMI 时钟差分信号正端    |
| tmds_clk_n     | G16      | LVDS 3.3V | HDMI 时钟差分信号负端    |
| tmds_data_p[2] | B8       | LVDS 3.3V | HDMI 数据通道2正端（红） |
| tmds_data_n[2] | A8       | LVDS 3.3V | HDMI 数据通道2负端（红） |
| tmds_data_p[1] | B9       | LVDS 3.3V | HDMI 数据通道1正端（绿） |
| tmds_data_n[1] | A9       | LVDS 3.3V | HDMI 数据通道1负端（绿） |
| tmds_data_p[0] | F15      | LVDS 3.3V | HDMI 数据通道0正端（蓝） |
| tmds_data_n[0] | F16      | LVDS 3.3V | HDMI 数据通道0负端（蓝） |

**注意**：以上引脚分配适用于 Cyclone 10 LP 10CL006YU256C8G 开发板。

### 硬件测试步骤

1. **连接 HDMI 显示器**

   - 使用标准 HDMI 线缆连接 FPGA 开发板的 HDMI 接口和显示器/电视
   - 确保显示器支持 1280×720@60Hz（720p）分辨率
2. **编译与下载**

   - 在 Quartus II/Prime 中打开工程文件 `hdmi_colorbar_top.qpf`
   - 执行完整编译（Analysis & Synthesis → Fitter → Assembler）
   - 生成 `.sof` 配置文件
   - 使用 USB Blaster 下载器连接 FPGA 板
   - 通过 Programmer 工具将 `.sof` 文件下载到 FPGA
3. **系统复位测试**

   - 按住 KEY0（sys_rst_n=0）进行系统复位
   - 复位期间显示器可能显示"无信号"或黑屏
   - 释放 KEY0（sys_rst_n=1），系统开始正常工作
   - PLL 锁定后（通常 1~2ms），显示器应显示稳定图像
4. **卡通动画交互测试**

   - **初始状态**：卡通角色应显示在屏幕中央位置
   - **按键 KEY1（向右移动）**：
     - 按住按键，角色向右连续移动
     - 角色朝向应自动转为向右
     - 移动过程中动作自动切换（6 种行走动画循环）
     - 松开按键，角色停止移动
   - **按键 KEY2（向左移动）**：
     - 按住按键，角色向左连续移动
     - 角色朝向应自动转为向左（水平镜像）
     - 移动过程中动作自动切换
     - 松开按键，角色停止移动
   - **边界检测**：角色到达屏幕边缘时停止移动
5. **显示效果验证**

   - **背景内容**：
     - 天空：蓝色背景
     - 云朵：白色云朵点缀
     - 草地：绿色草地区域
     - 平台：砖块平台结构
   - **角色显示**：
     - 尺寸：128×128 像素（原始 64×64，2 倍放大）
     - 动作流畅度：每 16 次移动切换一帧
     - 移动速度：约 20ms 移动 1 像素
     - 图像质量：应清晰无闪烁
   - **整体效果**：图像应稳定、动画流畅、交互响应及时
6. **信号完整性验证**（可选）

   - 使用高速示波器观测 TMDS 差分信号
   - 检查差分电压摆幅（应在 LVDS 规范范围内）
   - 验证信号眼图质量
   - 像素时钟频率：74.25MHz
   - 串行数据速率：742.5Mbps（10 倍像素时钟）

### 常见问题排查

1. **显示器无信号**

   - 检查 HDMI 线缆连接是否牢固
   - 确认 PLL 时钟锁定（可通过 SignalTap 调试）
   - 验证引脚分配是否与硬件匹配
   - 尝试按下复位键重新初始化
2. **显示异常或闪烁**

   - 检查时序约束是否正确设置
   - 确认 LVDS 输出电平标准配置
   - 验证差分对布线匹配度
   - 检查电源完整性
3. **角色不显示或显示错误**

   - 确认 walk.mem 和 walk_pal.mem 文件在正确路径
   - 检查 ROM 初始化是否成功
   - 验证坐标缩放逻辑
   - 检查颜色扩展算法
4. **按键无响应**

   - 检查按键引脚分配
   - 验证按键信号电平（建议加上拉电阻）
   - 确认 cartoon_ctr 模块例化正确
   - 检查 vs_flag 信号生成
5. **动画不流畅**

   - 检查移动速度计数器
   - 验证动作切换逻辑
   - 确认场同步信号正常

## 技术要点总结

### 与 VGA 卡通动画实验的对比

| 特性         | VGA 实验（640×480）     | HDMI 实验（1280×720）         |
| ------------ | ----------------------- | ------------------------------ |
| 接口类型     | VGA 模拟接口            | HDMI/DVI 数字接口              |
| 信号类型     | 并行 RGB + 同步信号     | TMDS 差分串行信号              |
| 时钟频率     | 25MHz（像素时钟）       | 74.25MHz（像素时钟）           |
| 颜色深度     | 12 位（4:4:4）          | 24 位（8:8:8）                 |
| 分辨率       | 640×480                | 1280×720                      |
| 图像尺寸     | 512×128（直接显示）     | 512×128 → 1024×256（2倍缩放） |
| 时钟管理     | PLL 分频                | PLL 倍频与分频                 |
| 编码方式     | 无编码（直接输出）      | TMDS 8b/10b 编码               |
| 传输技术     | 单端并行                | 差分串行 + DDR                 |
| 显示逻辑     | 直接坐标映射            | 坐标缩放 + 颜色扩展            |
| 精灵系统     | 32×64 像素精灵          | 32×64 → 64×128 缩放显示       |
| 控制系统     | 按键控制 + 动画切换     | 相同（移植自 VGA）             |
| ROM 数据格式 | 6 位索引 + 12 位调色板 | 相同（扩展为 24 位输出）       |

### 关键技术点

1. **PLL 时钟生成**：精确生成 74.25MHz 像素时钟和 371.25MHz 串行时钟
2. **TMDS 编码**：实现直流平衡和转换最小化的 8b/10b 编码
3. **高速串行化**：使用 DDR 和 DDIO 原语实现 10:1 并串转换
4. **差分信号驱动**：配置 LVDS 输出标准驱动 HDMI 物理层
5. **时序约束**：正确设置多时钟域约束和输出延迟约束
6. **复位同步**：跨时钟域的异步复位同步化处理
7. **坐标缩放**：将 1280×720 物理坐标缩放到 640×360 逻辑坐标
8. **颜色扩展**：12 位 RGB444 扩展为 24 位 RGB888
9. **精灵渲染**：基于查找表的精灵图渲染系统
10. **动画控制**：状态机实现的动作切换和位置更新
11. **按键去抖**：计数器实现的按键防抖动
12. **ROM 初始化**：使用 $readmemh 加载精灵图和调色板数据

### 核心设计思想

1. **模块化设计**：
   - 时序驱动层（video_driver）
   - 显示应用层（video_display）
   - 游戏逻辑层（cartoon_ctr）
   - 图像渲染层（rom_rgb）
   - 物理传输层（dvi_transmitter_top）

2. **资源复用**：
   - 复用 VGA 实验的精灵图数据
   - 复用卡通控制器逻辑
   - 通过坐标缩放适配不同分辨率

3. **性能优化**：
   - 使用查找表代替实时计算
   - 流水线设计减少延迟
   - 合理的时序约束保证高速信号质量

## 参考资料

- HDMI 1.4 规范
- DVI 1.0 规范
- CEA-861 标准（视频时序）
- TMDS 编码原理
- FPGA 高速串行接口设计指南

ChrisChan
更新日期：2025/10/28
