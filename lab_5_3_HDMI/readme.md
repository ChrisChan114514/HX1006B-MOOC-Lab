# lab_5_3-HDMI乐谱动态显示音乐播放器工程说明

## 工程概述

本工程是将VGAlab中的乐曲播放器+VGA乐谱动态显示功能改造为HDMI实现。整合了HDMI乐谱显示、动态方框指示和音乐播放三大功能模块，实现了乐谱的动态可视化播放。

## 改造内容

### 1. 顶层模块

- **文件**: `rtl/hdmi_music_player_top.v`
- **功能**: 整合HDMI显示和音乐播放器功能的顶层模块
- **接口**:
  - 系统输入: `sys_clk`, `sys_rst_n`
  - HDMI输出: `tmds_clk_p/n`, `tmds_data_p/n[2:0]`
  - 音乐输出: `speak` (扬声器), `high` (高音标志), `led[3:0]` (音符显示)

### 2. HDMI显示模块

- **video_display.v**:
  - 适配1位黑白ROM数据（512x256乐谱图像）
  - 将1位数据扩展为24位RGB888彩色输出
  - 红色边框显示（2像素宽）
  - **动态方框显示**: 根据cnt138信号实时绘制红色方框，标记当前播放的音符位置
  - 方框延迟调整: 延迟2个音符位置以匹配实际播放进度

### 3. 音乐播放器模块

源自VGAlab工程，位于 `rtl/`目录：

- `speak.v` - 扬声器驱动模块
- `f_code.v` - 音符译码器
- `DFF.v` - D触发器（产生方波）
- `cnt138t.v` - 138计数器（音符序列，同时驱动动态方框显示）
- `fdiv.v` - 分频器（产生4Hz节拍）

### 4. IP核文件

位于 `prj_1006B/ipcore/`目录：

- `pll_clk/` - HDMI像素时钟PLL
- `ddio_out/` - HDMI DDR输出
- `rom_bmp_hdmi.v` - 乐谱图片ROM（1位黑白数据，512x256）
- `pll_music.v` - 音乐播放器时钟PLL（1MHz和2KHz）
- `music.v` - 音乐数据ROM

### 5. 数据文件

位于 `prj_1006B/ipcore/`目录：

- `num512_256.mif` - 512x256乐谱图片数据（16列8行音符布局）
- `Mif1.mif` - 乐曲数据（138个音符）

## 功能特点

### HDMI显示功能

- 分辨率: 800x600 @ 60Hz
- 图片尺寸: 512x256像素（乐谱，居中显示）
- 乐谱布局: 16列 × 8行音符（共128个音符位置）
- 每个音符: 32x32像素
- 边框: 2像素宽红色边框
- 背景: 黑色
- 图片显示: 1位黑白数据转换为彩色显示

### 动态方框指示功能

- **实时跟踪**: 红色方框实时跟随当前播放的音符位置
- **方框尺寸**: 32x32像素（与音符尺寸一致）
- **位置计算**:
  - X坐标: 根据cnt138[3:0]确定列位置（0-15）
  - Y坐标: 根据cnt138[6:4]确定行位置（0-7）
  - 延迟补偿: 延迟2个音符位置以匹配播放进度
- **显示控制**: cnt138[7]控制方框显隐

### 音乐播放功能

- 音符数量: 138个
- 节拍速度: 4Hz
- 音调范围: 低音1-7，高音1-7
- LED显示: 4位LED显示当前音符
- 高音指示: high信号指示高音状态
- 播放同步: 音符播放与方框指示完全同步

## 时钟架构

### HDMI显示时钟

- **输入**: 50MHz系统时钟
- **PLL输出**:
  - `pixel_clk`: 40MHz（800x600@60Hz像素时钟）
  - `pixel_clk_5x`: 200MHz（HDMI串行化时钟）

### 音乐播放时钟

- **输入**: 50MHz系统时钟
- **PLL输出**:
  - `clk_1M`: 1MHz（扬声器PWM时钟）
  - `clk_2K`: 2KHz（分频器输入）
- **分频输出**:
  - `clk4hz`: 4Hz（音符节拍时钟）

## 测试功能

- **HDMI乐谱显示**: 应该看到居中显示的512x256乐谱图像，带红色边框
- **动态方框指示**: 红色方框会随着音乐播放在乐谱上移动，标记当前播放的音符位置
- **音乐播放**: 扬声器应该播放乐曲，LED显示当前音符
- **同步效果**: 方框移动与音乐播放完全同步

## 要点

### 坐标系统

- **HDMI实现**: 800x600屏幕，图片起始(144, 172)
- **方框偏移**: X方向-1像素，Y方向+1像素（相对图片边界）

### 方框位置计算

```verilog
// 延迟调整
cnt138_adjusted = (cnt138 >= 2) ? (cnt138 - 2) : 0

// 绝对坐标计算
pic_x_abs = (IMG_X_START - 1) + cnt138_adjusted[3:0] * 32
pic_y_abs = (IMG_Y_START + 1) + cnt138_adjusted[6:4] * 32
```

### ROM地址映射

```verilog
// 512x256图像，17位地址
rom_addr = {y[7:0], x[8:0]}  // y*512 + x
```
