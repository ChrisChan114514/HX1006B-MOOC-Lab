# lab_2_3 - DDS（直接数字频率合成器）设计

## 项目概述

本实验设计了基于ROM查找表的DDS（Direct Digital Synthesis，直接数字频率合成器）系统。DDS通过相位累加器和查找表技术实现可编程的正弦波信号生成，具有频率控制、相位控制和幅度控制功能。

本工程包含多个渐进式设计：

1. **基础DDS** (`dds_gen.v`/`dds_sin.v`) - 基本频率可调的正弦波发生器
2. **四分之一周期优化DDS** (`dds_quarter.v`) - 节省ROM资源，增加相位控制
3. **幅度可调DDS** (`dds_mult.v`) - 增加幅度调制功能
4. **在线调试版本** (`dds_gen_reg.v`) - 集成SignalTap调试接口
5. **顶层模块** (`dds_top.v`) - 按键控制的演示系统

## 工程文件说明

### 主要设计文件

- **`dds_gen.v`** / **`dds_sin.v`** - 基础DDS模块

  - 24位相位累加器，可编程频率控制字
  - 12位ROM地址空间（4096点），10位数据输出
  - 使用 `$readmemh` 从 `sin4096x10.txt` 读取完整周期正弦波数据
  - 频率输出 = (FreqWord × 时钟频率) / 2^24
- **`dds_quarter.v`** - 四分之一周期优化DDS

  - ROM容量减少75%，仅存储0-90度数据
  - 通过对称性计算完整周期（象限映射技术）
  - 增加24位相位偏移控制（PhaseWord）
  - 使用 `sin4096x10q.txt`（1024点数据）
- **`dds_mult.v`** - 幅度可调DDS

  - 在 `dds_quarter` 基础上增加幅度调制
  - 10位幅度控制字（AmpWord），支持正负幅度
  - 内部乘法器实现幅度缩放
  - 同时输出原始正弦波（q_sin）和调制后信号（q_mult）
- **`dds_gen_reg.v`** - 在线调试版本

  - 集成Qsys的SignalTap II调试接口（source_probe）
  - 支持在线修改频率控制字
  - 用于硬件调试和参数优化
- **`dds_top.v`** - 顶层演示模块

  - 使用3个按键控制频率、相位和幅度
  - 实例化 `dds_mult` 模块
  - 适合FPGA板载演示

### 数据文件

- **`sin4096x10.txt`** - 完整周期ROM数据

  - 4096点 × 10位，覆盖0-360度
  - 用于 `dds_gen` 和 `dds_sin` 模块
- **`sin4096x10q.txt`** - 四分之一周期ROM数据

  - 1024点 × 9位，覆盖0-90度
  - 用于 `dds_quarter` 和 `dds_mult` 模块
  - 通过对称性扩展生成完整周期

### 仿真文件

- **`dds_gen_tb.v`** - 基础DDS测试台

  - 验证频率控制功能
  - 动态切换FreqWord（50→200）
- **`dds_quarter_tb.v`** - 四分之一周期DDS测试台

  - 验证象限映射和相位偏移
  - 测试PhaseWord功能
- **`dds_mult_tb.v`** - 幅度调制DDS测试台

  - 验证幅度控制（正负幅度）
  - 对比原始波形和调制波形

### 工程配置文件

- **`dds_gen.qpf`** - Quartus工程文件
- **`dds_gen.qsf`** - Quartus设置文件，包含引脚分配和器件配置
- **`dds_gen.tcl`** - Tcl脚本文件
- **`source_probe.qsys`** - Qsys系统文件（SignalTap调试接口）
- **`db/`** - Quartus数据库目录
- **`incremental_db/`** - 增量编译数据库
- **`output_files/`** - 编译输出文件
- **`simulation/`** - 仿真文件目录
- **`source_probe/`** - 调试接口生成文件

## Verilog程序设计

### DDS原理

DDS通过以下核心技术实现可编程正弦波生成：

1. **相位累加器** - N位累加器以频率控制字为步进值累加，产生线性变化的相位
2. **相位-幅度转换** - 使用ROM查找表将相位映射为正弦幅度值
3. **频率分辨率** - 频率分辨率 = 时钟频率 / 2^N

### 模块1：基础DDS (dds_gen / dds_sin)

#### 端口定义

| 端口           | 方向   | 位宽 | 说明                   |
| -------------- | ------ | ---- | ---------------------- |
| clk            | input  | 1    | 系统时钟               |
| rst_n          | input  | 1    | 异步复位（低电平有效） |
| FreqWord[23:0] | input  | 24   | 频率控制字             |
| q_sin[9:0]     | output | 10   | 10位正弦波数据输出     |

#### 参数配置

- **N = 24** - 相位累加器位宽（决定频率分辨率）
- **M = 12** - ROM地址位宽（4096点）
- **W = 10** - 输出数据位宽

#### 功能说明

1. **相位累加器**

   - 24位累加器：`acc <= acc + FreqWord`
   - 累加器溢出产生周期性相位变化
2. **ROM查找表**

   - 4096 × 10位ROM存储完整周期正弦数据
   - ROM地址 = `acc[23:12]`（取累加器高12位）
   - 初始化：`$readmemh("sin4096x10.txt", sinrom)`
3. **输出**

   - 同步输出：`q_sin <= sinrom[acc>>(N-M)]`

### 模块2：四分之一周期DDS (dds_quarter)

#### 端口定义

| 端口            | 方向   | 位宽 | 说明       |
| --------------- | ------ | ---- | ---------- |
| clk             | input  | 1    | 系统时钟   |
| rst_n           | input  | 1    | 异步复位   |
| FreqWord[23:0]  | input  | 24   | 频率控制字 |
| PhaseWord[23:0] | input  | 24   | 相位偏移字 |
| q_sin[9:0]      | output | 10   | 正弦波输出 |

#### 参数配置

- **M = 12** - 但仅使用1024点ROM（M-2位地址）
- ROM存储0-90度数据，节省75% ROM资源

#### 功能说明

1. **相位累加与偏移**

   ```verilog
   acc <= acc + FreqWord;
   phase <= acc + PhaseWord;
   ```
2. **象限映射（四分之一周期对称）**

   - ROM地址：`romaddr = phase[21:12]`（10位地址，1024点）
   - **第一象限（0-90°）**：phase[23]=0, phase[22]=0 → 正向读取ROM
   - **第二象限（90-180°）**：phase[23]=0, phase[22]=1 → 反向读取ROM
   - **第三、四象限**：通过符号位phase[23]翻转幅度
3. **幅度计算**

   - 基准值：2^9 = 512（中心偏移）
   - phase[23]=0（上半周期）：`q_sin = 512 + romdata`
   - phase[23]=1（下半周期）：`q_sin = 512 - romdata`

### 模块3：幅度可调DDS (dds_mult)

#### 端口定义

| 端口            | 方向   | 位宽 | 说明               |
| --------------- | ------ | ---- | ------------------ |
| clk             | input  | 1    | 系统时钟           |
| rst_n           | input  | 1    | 异步复位           |
| FreqWord[23:0]  | input  | 24   | 频率控制字         |
| PhaseWord[23:0] | input  | 24   | 相位偏移字         |
| AmpWord[9:0]    | input  | 10   | 幅度控制字         |
| q_sin[9:0]      | output | 10   | 原始正弦波         |
| q_mult[9:0]     | output | 10   | 幅度调制后的正弦波 |

#### 参数配置

- **MA = 10** - 幅度控制字位宽

#### 功能说明

1. **幅度处理**

   - AmpWord[9]为符号位
   - `ampdata = AmpWord[9] ? AmpWord[8:0] : 512 - AmpWord[8:0]`
   - 支持双向幅度控制（增益/衰减）
2. **乘法运算**

   - `multdata = romdata × ampdata`
   - 结果右移9位归一化
3. **输出控制**

   - q_sin：原始正弦波（与dds_quarter相同）
   - q_mult：幅度调制信号，符号由phase[23]和AmpWord[9]异或决定

### 模块4：顶层模块 (dds_top)

#### 端口定义

| 端口     | 方向  | 位宽 | 说明            |
| -------- | ----- | ---- | --------------- |
| clk      | input | 1    | 系统时钟        |
| rst_n    | input | 1    | 复位信号        |
| key[2:0] | input | 3    | 3个按键控制输入 |

#### 功能说明

- **按键映射**：
  - key[0] → FreqWord[15]（频率切换）
  - key[1] → PhaseWord[19]（相位切换）
  - key[2] → AmpWord[8]（幅度切换）
- 实例化 `dds_mult` 模块实现完整DDS功能

## ModelSim仿真

### 仿真1：基础DDS (dds_gen_tb.v)

**测试目标**：验证频率控制功能

**仿真参数**：

- 时钟周期：100ns（10MHz）
- 时间刻度：`timescale 10ns/100ps`
- 复位时间：15个时间单位后释放

**测试场景**：

1. 初始频率控制字 FreqWord = 50
2. 运行4,000,000个时间单位后
3. 切换频率控制字 FreqWord = 200
4. 再运行4,000,000个时间单位

**预期结果**：

- 观察 `Q[9:0]` 输出波形
- 频率切换后，输出频率应增加4倍
- 输出频率 = (FreqWord × 10MHz) / 2^24

### 仿真2：四分之一周期DDS (dds_quarter_tb.v)

**测试目标**：验证象限映射和相位偏移

**仿真参数**：

- 时钟周期：100ns
- FreqWord = 50
- PhaseWord = 200 × 4096 = 819,200（相位偏移）

**预期结果**：

- 验证四分之一周期对称算法正确性
- 观察相位偏移效果
- 波形应保持连续性和对称性

### 仿真3：幅度调制DDS (dds_mult_tb.v)

**测试目标**：验证幅度控制和调制功能

**测试场景**：

1. FreqWord = 50，PhaseWord = 200
2. 初始幅度 AmpWord = 512 - 256 = 256（负幅度/衰减）
3. 4,000,000时间单位后
4. 切换幅度 AmpWord = 512 + 256 = 768（正幅度/增益）

**预期结果**：

- `q` 输出：原始正弦波（固定幅度）
- `qm` 输出：幅度调制后的正弦波
- 幅度切换前后，`qm` 波形幅度和符号应明显变化
