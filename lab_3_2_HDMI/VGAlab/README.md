# lab_3_2 - VGA 位图图像显示控制器

## 项目概述

本实验设计了一个基于 VGA 时序的位图图像显示系统，实现了 640×480@60Hz 的 VGA 显示输出。系统通过 ROM 存储位图数据（256×128 像素），并在 VGA 显示屏幕中央显示该图像，周围以黑色填充，边框用红色标识显示区域边界。

## Verilog程序设计

### 整体架构

本项目由两个主要模块组成：

1. **vga_bmp（顶层模块）**：系统时钟分频，例化 ROM 和 VGA 显示控制器
2. **vga_disp（显示控制模块）**：VGA 时序生成和图像显示控制
3. **rom_bmp（ROM 模块）**：存储 256×128 像素的位图数据（6 位颜色深度）

### 模块功能

#### vga_bmp（顶层模块）

- **时钟分频**：将 50MHz 系统时钟二分频为 25MHz VGA 像素时钟
- **异步复位**：支持低电平异步复位
- **模块例化**：实例化 ROM 和 VGA 显示控制模块
- **数据流控制**：从 ROM 读取位图数据并传递给显示控制器

#### vga_disp（显示控制模块）

- **VGA 时序生成**：生成符合 640×480@60Hz 标准的行同步和场同步信号
- **位图显示**：在屏幕中央（192,176）位置显示 256×128 像素的图像
- **颜色扩展**：将 6 位 RGB（2:2:2）数据扩展为 12 位 RGB（4:4:4）输出
- **边框显示**：在显示区域边界绘制红色边框（2 像素宽）
- **地址生成**：根据当前像素坐标生成 ROM 读取地址

#### rom_bmp（ROM 模块）

- **存储容量**：32768 字（256×128 = 32K 地址空间）
- **数据宽度**：6 位（RGB 各 2 位）
- **初始化文件**：logo.mif（包含位图图像数据）
- **读取模式**：同步 ROM，单端口读取

### 功能实现机制

#### VGA 时序生成

- **像素时钟**：25MHz（由 50MHz 系统时钟二分频获得）
- **水平时序**：总计 800 个时钟周期
  - 显示区：640 像素
  - 前肩：8 像素
  - 同步脉冲：96 像素
  - 后肩：56 像素
- **垂直时序**：总计 525 行
  - 显示区：480 行
  - 前肩：8 行
  - 同步脉冲：2 行
  - 后肩：35 行

#### 同步信号生成

- **行同步信号（HSYNC）**：在水平计数 656~751（640+8+8 到 640+8+8+95）期间为低电平
- **场同步信号（VSYNC）**：在垂直计数 490~491（480+8+2 到 480+8+2+1）期间为低电平
- **同步极性**：负极性同步（同步期间为低电平）

#### 位图图像显示

- **图像尺寸**：256×128 像素（存储在 ROM 中）
- **显示位置**：屏幕中央，起始坐标 x=(640-256)/2=192，y=(480-128)/2=176
- **坐标转换**：
  - x = hcnt - 192（水平相对坐标）
  - y = vcnt - 176（垂直相对坐标）
- **显示使能**：当 x<256 且 y<128 时，从 ROM 读取并显示图像数据
- **ROM 地址**：addr = {y[6:0], x[7:0]}（15 位地址，覆盖 256×128 区域）
- **颜色扩展**：将 6 位 RGB（每通道 2 位）扩展为 12 位 RGB（每通道 4 位）
  - R[3:0] = {rgb[1], rgb[1], rgb[0], rgb[0]}
  - G[3:0] = {rgb[3], rgb[3], rgb[2], rgb[2]}
  - B[3:0] = {rgb[5], rgb[5], rgb[4], rgb[4]}

#### 边框和背景

- **红色边框**：在显示区域边界（前 2 像素和后 2 像素）显示红色（12'hf00）
- **黑色背景**：显示区域外的其他位置显示黑色（12'h000）

### 端口说明

#### vga_bmp（顶层模块）

| 端口        | 方向   | 位宽 | 说明                                       |
| ----------- | ------ | ---- | ------------------------------------------ |
| clk         | input  | 1    | 50MHz 系统时钟                             |
| reset_n     | input  | 1    | 异步复位信号（低电平有效）                 |
| VGA_HSYNC   | output | 1    | VGA 行同步信号（负极性）                   |
| VGA_VSYNC   | output | 1    | VGA 场同步信号（负极性）                   |
| VGA_D[11:0] | output | 12   | VGA RGB 颜色数据（R[3:0], G[3:0], B[3:0]） |

#### vga_disp（显示控制模块）

| 端口        | 方向   | 位宽 | 说明                                    |
| ----------- | ------ | ---- | --------------------------------------- |
| clk25M      | input  | 1    | 25MHz 像素时钟                          |
| reset_n     | input  | 1    | 异步复位信号（低电平有效）              |
| rgb[5:0]    | input  | 6    | ROM 输出的 6 位 RGB 数据（R:G:B=2:2:2） |
| VGA_HSYNC   | output | 1    | VGA 行同步信号                          |
| VGA_VSYNC   | output | 1    | VGA 场同步信号                          |
| addr[14:0]  | output | 15   | ROM 地址（256×128=32K 地址空间）       |
| VGA_D[11:0] | output | 12   | VGA RGB 颜色数据（扩展后 4:4:4）        |

#### rom_bmp（ROM 模块）

| 端口          | 方向   | 位宽 | 说明                           |
| ------------- | ------ | ---- | ------------------------------ |
| address[14:0] | input  | 15   | ROM 读取地址（0~32767）        |
| clock         | input  | 1    | 读取时钟（25MHz）              |
| q[5:0]        | output | 6    | 6 位 RGB 数据（R:G:B = 2:2:2） |

## ModelSim(Verilog TB代码仿真)

本工程可创建仿真测试平台用于验证 VGA 位图显示控制器的功能。

### 仿真环境配置

- **时间单位**：`timescale 1ns/1ps`（时间刻度 1ns，时间精度 1ps）
- **时钟频率**：50MHz（周期 20ns）
- **像素时钟**：25MHz（周期 40ns）
- **仿真时长**：建议 20ms 以上（覆盖至少一帧完整的 VGA 显示周期）

### 测试激励

1. **时钟生成**：产生 50MHz 连续系统时钟信号
2. **复位序列**：
   - 初始时刻 reset_n=0，复位系统
   - 100ns 后释放复位（reset_n=1）
3. **ROM 数据**：通过 logo.mif 文件加载位图图像数据
4. **运行测试**：仿真足够时间，观察完整的图像显示过程

### 观察信号

- **VGA_HSYNC**：行同步脉冲周期 32μs（800×40ns），低电平宽度 3.84μs
- **VGA_VSYNC**：场同步脉冲周期 16.7ms（525 行），低电平宽度约 64μs
- **addr**：ROM 地址信号，在图像显示区域从 0 循环到 32767
- **rgb**：ROM 输出的 6 位颜色数据
- **VGA_D**：在图像区域显示位图颜色，边框显示红色，其他区域显示黑色

### 仿真要点

- 验证 ROM 地址生成是否正确（在图像区域 addr = y×256 + x）
- 检查颜色扩展逻辑是否正确（6 位扩展为 12 位）
- 确认边框和背景显示是否符合预期
- 观察图像显示位置是否在屏幕中央

## FPGA板子硬件实验

生成 `.sof` 配置文件，下载到 FPGA 开发板进行硬件验证。

### 引脚绑定

#### 输入信号

| 信号    | FPGA引脚 | 硬件元件 | 说明                     |
| ------- | -------- | -------- | ------------------------ |
| clk     | E15      | 50MHz    | 系统时钟（板载晶振）     |
| reset_n | M1       | KEY1     | 复位信号（按下为低电平） |

#### 输出信号

| 信号      | FPGA引脚 | 硬件元件 | 说明               |
| --------- | -------- | -------- | ------------------ |
| VGA_HSYNC | P16      | VGA_HS   | VGA 行同步信号     |
| VGA_VSYNC | N15      | VGA_VS   | VGA 场同步信号     |
| VGA_D[11] | F15      | VGA_R3   | VGA 红色通道最高位 |
| VGA_D[10] | F16      | VGA_R2   | VGA 红色通道位2    |
| VGA_D[9]  | G15      | VGA_R1   | VGA 红色通道位1    |
| VGA_D[8]  | G16      | VGA_R0   | VGA 红色通道最低位 |
| VGA_D[7]  | J11      | VGA_G3   | VGA 绿色通道最高位 |
| VGA_D[6]  | J16      | VGA_G2   | VGA 绿色通道位2    |
| VGA_D[5]  | J15      | VGA_G1   | VGA 绿色通道位1    |
| VGA_D[4]  | K16      | VGA_G0   | VGA 绿色通道最低位 |
| VGA_D[3]  | K15      | VGA_B3   | VGA 蓝色通道最高位 |
| VGA_D[2]  | L16      | VGA_B2   | VGA 蓝色通道位2    |
| VGA_D[1]  | L15      | VGA_B1   | VGA 蓝色通道位1    |
| VGA_D[0]  | N16      | VGA_B0   | VGA 蓝色通道最低位 |

### 硬件测试步骤

1. **连接 VGA 显示器**

   - 使用 VGA 线缆连接 FPGA 开发板的 VGA 接口和显示器
   - 确保显示器支持 640×480@60Hz 分辨率
2. **下载配置文件**

   - 在 Quartus II 中编译工程，生成 `.sof` 文件
   - 使用 USB Blaster 或其他下载器将配置文件下载到 FPGA
3. **复位测试**

   - 按下 KEY1（reset_n=0）复位系统
   - 显示器应显示黑屏或无信号状态
   - 松开 KEY1（reset_n=1），系统开始正常工作
4. **显示效果观察**

   - 正常工作后，显示器中央应显示 256×128 像素的位图图像
   - 图像内容由 logo.mif 文件定义
   - 图像周围显示黑色背景
   - 图像边界有 2 像素宽的红色边框
   - 图像显示位置：水平居中（192~447），垂直居中（176~303）
5. **时序验证**

   - 使用示波器或逻辑分析仪可以观测 VGA_HSYNC 和 VGA_VSYNC 信号
   - 行同步周期：约 32μs（800×40ns）
   - 场同步周期：约 16.7ms（525×32μs）
   - 刷新率：约 60Hz

### 注意事项

- **logo.mif 文件**：必须存在于工程目录中，包含 32768 个 6 位数据
- **ROM 初始化**：Quartus 编译时会自动将 logo.mif 内容加载到 ROM
- **颜色深度**：ROM 存储 6 位颜色（2:2:2），显示时扩展为 12 位（4:4:4）
- **图像格式**：256 宽×128 高，逐行存储，地址 = y×256 + x

## 项目文件说明

| 文件名         | 类型         | 说明                                 |
| -------------- | ------------ | ------------------------------------ |
| vga_bmp.v      | Verilog HDL  | 顶层模块，时钟分频和模块例化         |
| vga_disp.v     | Verilog HDL  | VGA 显示控制模块，时序生成和图像显示 |
| rom_bmp.v      | Verilog HDL  | ROM IP 核文件（自动生成）            |
| rom_bmp_inst.v | Verilog HDL  | ROM 例化模板文件                     |
| rom_bmp_bb.v   | Verilog HDL  | ROM 黑盒文件                         |
| rom_bmp.qip    | QIP 文件     | Quartus IP 文件，包含 ROM 配置信息   |
| logo.mif       | MIF 文件     | 位图数据初始化文件（32768×6bit）    |
| vga_bmp.qpf    | Quartus 项目 | Quartus Prime 项目文件               |
| vga_bmp.qsf    | Quartus 设置 | 引脚分配和编译设置文件               |
| vga_bmp.tcl    | TCL 脚本     | Quartus 自动化脚本                   |
| db/            | 目录         | Quartus 数据库文件夹                 |

### 颜色扩展算法

6 位 RGB 扩展为 12 位 RGB，采用位复制方法：

- 每个 2 位颜色通道扩展为 4 位
- 扩展方式：{bit[1], bit[1], bit[0], bit[0]}
- 示例：2'b11 → 4'b1111，2'b10 → 4'b1100，2'b01 → 4'b0011

ChrisChan
2025/10/28
