# lab_3_1 - VGA 彩色显示控制器

## 项目概述

本实验设计了一个基于 VGA 时序的彩色显示控制器，实现了 640×480@60Hz 的 VGA 显示输出，支持异步复位功能，能够在屏幕上显示简单的彩色图案。

## Verilog程序设计

### 模块功能

`vga_disp` 模块实现了一个 VGA 显示控制器，具有以下特性：

- **VGA 时序生成**：生成符合 640×480@60Hz 标准的行同步和场同步信号
- **异步复位**：低电平异步复位功能，优先级最高
- **分频时钟**：内部将 50MHz 时钟分频至 25MHz 作为 VGA 像素时钟
- **彩色显示**：输出 12 位 RGB 颜色数据（R:G:B = 4:4:4）
- **图案生成**：基于像素坐标生成彩色条纹图案
- **显示使能**：在有效显示区域（640×480）内输出彩色数据，消隐区输出黑色

### 功能实现机制

#### VGA 时序生成

- **像素时钟**：25MHz（由 50MHz 系统时钟二分频获得）
- **水平时序**：总计 800 个时钟周期
  - 显示区：640 像素
  - 前肩：8 像素
  - 同步脉冲：96 像素
  - 后肩：56 像素
- **垂直时序**：总计 525 行
  - 显示区：480 行
  - 前肩：8 行
  - 同步脉冲：2 行
  - 后肩：35 行

#### 同步信号生成

- **行同步信号（HSYNC）**：在水平计数 656~751（640+8+8 到 640+8+8+95）期间为低电平
- **场同步信号（VSYNC）**：在垂直计数 490~491（480+8+2 到 480+8+2+1）期间为低电平
- **同步极性**：负极性同步（同步期间为低电平）

#### 彩色图案生成

- **显示使能**：仅在 x<640 且 y<480 的有效显示区域输出彩色数据
- **颜色计算**：使用水平坐标 x[8:6] 生成 3 位 RGB 信号，每个颜色通道扩展为 4 位
- **图案效果**：水平方向呈现 8 种颜色的渐变条纹（黑、蓝、绿、青、红、品红、黄、白）

### 端口说明

| 端口        | 方向   | 位宽 | 说明                                       |
| ----------- | ------ | ---- | ------------------------------------------ |
| clk         | input  | 1    | 50MHz 系统时钟                             |
| reset_n     | input  | 1    | 异步复位信号（低电平有效）                 |
| VGA_HSYNC   | output | 1    | VGA 行同步信号（负极性）                   |
| VGA_VSYNC   | output | 1    | VGA 场同步信号（负极性）                   |
| VGA_D[11:0] | output | 12   | VGA RGB 颜色数据（R[3:0], G[3:0], B[3:0]） |

## ModelSim(Verilog TB代码仿真)

本工程包含完整的仿真测试平台 `vga_disp_tb.v`，用于验证 VGA 时序控制器的功能。

### 仿真环境配置

- **时间单位**：`timescale 10ns/100ps`（时间刻度 10ns，时间精度 100ps）
- **时钟频率**：50MHz（周期 100ns，仿真中为 10 个时间单位）
- **仿真时长**：4.2ms（覆盖约 8 帧完整的 VGA 显示周期）

### 测试激励

1. **时钟生成**：产生 50MHz 连续时钟信号
2. **复位序列**：
   - 初始时刻 reset_n=0，复位系统
   - 150ns 后释放复位（reset_n=1）
3. **运行测试**：仿真 4.2ms，观察多个完整帧的 VGA 时序

### 观察信号

- **VGA_HSYNC**：行同步脉冲周期 32μs（800×40ns），低电平宽度 3.84μs
- **VGA_VSYNC**：场同步脉冲周期 16.7ms（525 行），低电平宽度约 64μs
- **VGA_D**：在有效显示区域输出彩色数据，消隐区输出 0

## FPGA板子硬件实验

生成 `.sof` 配置文件，下载到 FPGA 开发板进行硬件验证。

### 引脚绑定

#### 输入信号

| 信号    | FPGA引脚 | 硬件元件 | 说明                     |
| ------- | -------- | -------- | ------------------------ |
| clk     | P11      | 50MHz    | 系统时钟（板载晶振）     |
| reset_n | M1       | KEY1     | 复位信号（按下为低电平） |

#### 输出信号

| 信号      | FPGA引脚 | 硬件元件 | 说明               |
| --------- | -------- | -------- | ------------------ |
| VGA_HSYNC | A8       | VGA_HS   | VGA 行同步信号     |
| VGA_VSYNC | D6       | VGA_VS   | VGA 场同步信号     |
| VGA_D[11] | B10      | VGA_R3   | VGA 红色通道最高位 |
| VGA_D[10] | A10      | VGA_R2   | VGA 红色通道位2    |
| VGA_D[9]  | C9       | VGA_R1   | VGA 红色通道位1    |
| VGA_D[8]  | D9       | VGA_R0   | VGA 红色通道最低位 |
| VGA_D[7]  | A9       | VGA_G3   | VGA 绿色通道最高位 |
| VGA_D[6]  | B9       | VGA_G2   | VGA 绿色通道位2    |
| VGA_D[5]  | A7       | VGA_G1   | VGA 绿色通道位1    |
| VGA_D[4]  | B7       | VGA_G0   | VGA 绿色通道最低位 |
| VGA_D[3]  | D8       | VGA_B3   | VGA 蓝色通道最高位 |
| VGA_D[2]  | C8       | VGA_B2   | VGA 蓝色通道位2    |
| VGA_D[1]  | B8       | VGA_B1   | VGA 蓝色通道位1    |
| VGA_D[0]  | A6       | VGA_B0   | VGA 蓝色通道最低位 |

### 硬件测试步骤

1. **连接 VGA 显示器**

   - 使用 VGA 线缆连接 FPGA 开发板的 VGA 接口和显示器
   - 确保显示器支持 640×480@60Hz 分辨率
2. **下载配置文件**

   - 在 Quartus II 中编译工程，生成 `.sof` 文件
   - 使用 USB Blaster 或其他下载器将配置文件下载到 FPGA
3. **复位测试**

   - 按下 KEY1（reset_n=0）复位系统
   - 显示器应显示黑屏或无信号状态
   - 松开 KEY1（reset_n=1），系统开始正常工作
4. **显示效果观察**

   - 正常工作后，显示器应显示 8 条垂直的彩色条纹
   - 颜色从左到右依次为：黑、蓝、绿、青、红、品红、黄、白
   - 每条色带宽度约为 80 像素（640÷8）
5. **时序验证**

   - 使用示波器或逻辑分析仪可以观测 VGA_HSYNC 和 VGA_VSYNC 信号
   - 行同步周期：约 31.78μs（800×40ns）
   - 场同步周期：约 16.68ms（525×31.78μs）
   - 刷新率：约 60Hz

ChrisChan
2025/10/27
