# lab_3_1 - HDMI 彩色显示控制器

## 项目概述

本实验设计了一个基于 HDMI/DVI 协议的彩色显示控制器，实现了 1280×720@60Hz 的高清显示输出，采用 TMDS 差分信号传输，能够在屏幕上显示 8 条彩色条纹图案。

## Verilog程序设计

### 系统架构

HDMI 显示系统由以下核心模块组成：

1. **hdmi_colorbar_top**：顶层模块，集成时钟管理和各子模块
2. **pll_clk**：PLL 时钟生成模块，产生 74.25MHz 像素时钟和 371.25MHz 串行时钟
3. **video_driver**：视频时序驱动模块，生成 1280×720@60Hz 时序信号
4. **video_display**：视频显示模块，根据坐标生成 8 条彩色条纹图案  （**本次实验重点修改的文件**）
5. **dvi_transmitter_top**：DVI/HDMI 传输顶层模块
6. **dvi_encoder**：DVI 编码器，执行 TMDS 8b/10b 编码
7. **serializer_10_to_1**：10:1 并串转换器，使用 DDR 输出技术
8. **asyn_rst_syn**：异步复位同步化模块

### video_display 模块功能

`video_display` 模块是应用层显示逻辑模块，负责生成显示内容，具有以下特性：

- **分辨率支持**：1280×720 像素（720p）
- **颜色深度**：24 位 RGB888 全彩色输出
- **图案生成**：基于像素横坐标高 3 位生成 8 种颜色条纹
- **颜色序列**：黑、蓝、绿、青、红、品红、黄、白（与 VGA 实验一致）
- **显示逻辑**：使用 case 语句根据 pixel_xpos[10:8] 选择颜色

### 功能实现机制

#### 时钟生成

- **系统输入时钟**：50MHz
- **PLL 输出**：
  - 像素时钟：74.25MHz（用于 720p@60Hz 时序）
  - 串行时钟：371.25MHz（5 倍像素时钟，用于 TMDS 串行化）

#### 720p 视频时序

- **像素时钟**：74.25MHz
- **水平时序**：总计 1650 个时钟周期
  - 显示区：1280 像素
  - 前肩：110 像素
  - 同步脉冲：40 像素
  - 后肩：220 像素
- **垂直时序**：总计 750 行
  - 显示区：720 行
  - 前肩：5 行
  - 同步脉冲：5 行
  - 后肩：20 行
- **帧率**：60Hz（74.25MHz ÷ 1650 ÷ 750 ≈ 60Hz）

#### 彩色图案生成算法

`video_display` 模块通过以下方式生成 8 条彩色条纹：

```verilog
case(pixel_xpos[10:8])  // 使用横坐标的高3位
    3'd0: pixel_data <= BLACK;    // 000 - 黑色   (0~159像素)
    3'd1: pixel_data <= BLUE;     // 001 - 蓝色   (160~319像素)
    3'd2: pixel_data <= GREEN;    // 010 - 绿色   (320~479像素)
    3'd3: pixel_data <= CYAN;     // 011 - 青色   (480~639像素)
    3'd4: pixel_data <= RED;      // 100 - 红色   (640~799像素)
    3'd5: pixel_data <= MAGENTA;  // 101 - 品红色 (800~959像素)
    3'd6: pixel_data <= YELLOW;   // 110 - 黄色   (960~1119像素)
    3'd7: pixel_data <= WHITE;    // 111 - 白色   (1120~1279像素)
endcase
```

- **条纹宽度**：每条 160 像素（1280 ÷ 8）
- **颜色编码**：RGB888 格式（24 位真彩色）
- **设计理念**：与 VGA 实验中的 x[8:6] 设计思路一致，实现相同的视觉效果

#### TMDS 编码与传输

- **编码方式**：8b/10b TMDS 编码（直流平衡编码）
- **通道数量**：3 个数据通道（R、G、B）+ 1 个时钟通道
- **差分信号**：每个通道使用差分对传输（P/N）
- **串行化**：使用 DDR 技术实现 10:1 并串转换

### 端口说明

#### hdmi_colorbar_top 顶层模块

| 端口           | 方向   | 位宽 | 说明                              |
| -------------- | ------ | ---- | --------------------------------- |
| sys_clk        | input  | 1    | 50MHz 系统时钟                    |
| sys_rst_n      | input  | 1    | 系统复位信号（低电平有效）        |
| tmds_clk_p     | output | 1    | TMDS 时钟差分信号正端             |
| tmds_clk_n     | output | 1    | TMDS 时钟差分信号负端             |
| tmds_data_p[2] | output | 1    | TMDS 数据通道 2 差分信号正端（R） |
| tmds_data_n[2] | output | 1    | TMDS 数据通道 2 差分信号负端（R） |
| tmds_data_p[1] | output | 1    | TMDS 数据通道 1 差分信号正端（G） |
| tmds_data_n[1] | output | 1    | TMDS 数据通道 1 差分信号负端（G） |
| tmds_data_p[0] | output | 1    | TMDS 数据通道 0 差分信号正端（B） |
| tmds_data_n[0] | output | 1    | TMDS 数据通道 0 差分信号负端（B） |

#### video_display 应用层模块

| 端口           | 方向   | 位宽 | 说明                       |
| -------------- | ------ | ---- | -------------------------- |
| pixel_clk      | input  | 1    | 74.25MHz 像素时钟          |
| sys_rst_n      | input  | 1    | 系统复位信号（低电平有效） |
| pixel_xpos     | input  | 11   | 当前像素横坐标（0~1279）   |
| pixel_ypos     | input  | 11   | 当前像素纵坐标（0~719）    |
| pixel_data[23] | output | 24   | 像素颜色数据 RGB888 格式   |

## ModelSim 仿真验证

本工程包含完整的仿真测试平台 `tb_hdmi_colorbar_top.v`，用于验证 HDMI 显示系统的功能。

### 仿真环境配置

- **时间单位**：`timescale 1ns/1ps`
- **系统时钟**：50MHz（周期 20ns）
- **像素时钟**：74.25MHz（由 PLL 生成）
- **串行时钟**：371.25MHz（由 PLL 生成）
- **仿真时长**：建议至少 30ms，覆盖 1~2 帧完整的显示周期

### 测试激励

1. **时钟生成**：产生 50MHz 连续系统时钟
2. **复位序列**：
   - 初始时刻 sys_rst_n=0，复位系统
   - 200ns 后释放复位（sys_rst_n=1）
3. **运行测试**：观察 TMDS 差分信号输出和时序

### 主要观察信号

- **video_hs/video_vs**：内部视频同步信号（720p 时序）
- **video_de**：数据使能信号（有效显示区域标识）
- **pixel_data**：24 位 RGB 像素数据，应呈现 8 种颜色循环
- **tmds_data_p/n**：TMDS 差分数据信号
- **tmds_clk_p/n**：TMDS 差分时钟信号

### 时序参数验证

- **行周期**：约 22.2μs（1650 × 13.47ns）
- **场周期**：约 16.7ms（750 行 × 22.2μs）
- **帧率**：60Hz

## FPGA 硬件实验

在 Quartus 中综合并生成 `.sof` 配置文件，下载到 FPGA 开发板进行硬件验证。

### 引脚绑定

#### 输入信号

| 信号      | FPGA引脚 | 电气标准 | 说明                       |
| --------- | -------- | -------- | -------------------------- |
| sys_clk   | P11      | 3.3V     | 50MHz 系统时钟（板载晶振） |
| sys_rst_n | M1       | 3.3V     | 系统复位（KEY1 按键）      |

#### 输出信号（HDMI 接口）

| 信号           | FPGA引脚 | 电气标准  | 说明                     |
| -------------- | -------- | --------- | ------------------------ |
| tmds_clk_p     | D6       | LVDS 3.3V | HDMI 时钟差分信号正端    |
| tmds_clk_n     | C6       | LVDS 3.3V | HDMI 时钟差分信号负端    |
| tmds_data_p[2] | H5       | LVDS 3.3V | HDMI 数据通道2正端（红） |
| tmds_data_n[2] | G5       | LVDS 3.3V | HDMI 数据通道2负端（红） |
| tmds_data_p[1] | E8       | LVDS 3.3V | HDMI 数据通道1正端（绿） |
| tmds_data_n[1] | D8       | LVDS 3.3V | HDMI 数据通道1负端（绿） |
| tmds_data_p[0] | B7       | LVDS 3.3V | HDMI 数据通道0正端（蓝） |
| tmds_data_n[0] | A7       | LVDS 3.3V | HDMI 数据通道0负端（蓝） |

**注意**：以上引脚分配需根据实际开发板原理图进行调整。

### 硬件测试步骤

1. **连接 HDMI 显示器**

   - 使用标准 HDMI 线缆连接 FPGA 开发板的 HDMI 接口和显示器/电视
   - 确保显示器支持 1280×720@60Hz（720p）分辨率
   - 部分显示器可能需要手动切换输入源
2. **编译与下载**

   - 在 Quartus II/Prime 中打开工程文件 `hdmi_colorbar_top.qpf`
   - 执行完整编译（Analysis & Synthesis → Fitter → Assembler）
   - 生成 `.sof` 配置文件
   - 使用 USB Blaster 下载器连接 FPGA 板
   - 通过 Programmer 工具将 `.sof` 文件下载到 FPGA
3. **系统复位测试**

   - 按住 KEY1（sys_rst_n=0）进行系统复位
   - 复位期间显示器可能显示"无信号"或黑屏
   - 释放 KEY1（sys_rst_n=1），系统开始正常工作
   - PLL 锁定后（通常 1~2ms），显示器应显示稳定图像
4. **显示效果验证**

   - **图案内容**：显示 8 条垂直彩色条纹
   - **颜色顺序**（从左到右）：
     1. 黑色（Black）
     2. 蓝色（Blue）
     3. 绿色（Green）
     4. 青色（Cyan）
     5. 红色（Red）
     6. 品红色（Magenta）
     7. 黄色（Yellow）
     8. 白色（White）
   - **条纹宽度**：每条约 160 像素（1280 ÷ 8）
   - **显示质量**：图像应稳定无闪烁，颜色鲜艳饱和
5. **信号完整性验证**（可选）

   - 使用高速示波器观测 TMDS 差分信号
   - 检查差分电压摆幅（应在 LVDS 规范范围内）
   - 验证信号眼图质量
   - 像素时钟频率：74.25MHz
   - 串行数据速率：742.5Mbps（10 倍像素时钟）

### 常见问题排查

1. **显示器无信号**

   - 检查 HDMI 线缆连接是否牢固
   - 确认 PLL 时钟锁定（可通过 SignalTap 调试）
   - 验证引脚分配是否与硬件匹配
   - 尝试按下复位键重新初始化
2. **显示异常或闪烁**

   - 检查时序约束是否正确设置
   - 确认 LVDS 输出电平标准配置
   - 验证差分对布线匹配度
   - 检查电源完整性
3. **颜色错误**

   - 确认 RGB 通道映射关系
   - 检查 `video_display.v` 中的颜色定义
   - 验证 TMDS 编码逻辑

## 技术要点总结

### 与 VGA 实验的对比

| 特性         | VGA 实验（640×480） | HDMI 实验（1280×720）       |
| ------------ | -------------------- | ---------------------------- |
| 接口类型     | VGA 模拟接口         | HDMI/DVI 数字接口            |
| 信号类型     | 并行 RGB + 同步信号  | TMDS 差分串行信号            |
| 时钟频率     | 25MHz（像素时钟）    | 74.25MHz（像素时钟）         |
| 颜色深度     | 12 位（4:4:4）       | 24 位（8:8:8）               |
| 分辨率       | 640×480             | 1280×720                    |
| 时钟管理     | 简单分频             | PLL 倍频与分频               |
| 编码方式     | 无编码（直接输出）   | TMDS 8b/10b 编码             |
| 传输技术     | 单端并行             | 差分串行 + DDR               |
| 显示图案逻辑 | x[8:6] → 8 色条纹   | pixel_xpos[10:8] → 8 色条纹 |
| 颜色顺序     | 黑蓝绿青红品红黄白   | 黑蓝绿青红品红黄白（一致）   |

### 关键技术点

1. **PLL 时钟生成**：精确生成 74.25MHz 像素时钟和 371.25MHz 串行时钟
2. **TMDS 编码**：实现直流平衡和转换最小化的 8b/10b 编码
3. **高速串行化**：使用 DDR 和 DDIO 原语实现 10:1 并串转换
4. **差分信号驱动**：配置 LVDS 输出标准驱动 HDMI 物理层
5. **时序约束**：正确设置多时钟域约束和输出延迟约束
6. **复位同步**：跨时钟域的异步复位同步化处理

## 参考资料

- HDMI 1.4 规范
- DVI 1.0 规范
- CEA-861 标准（视频时序）
- TMDS 编码原理
- FPGA 高速串行接口设计指南

ChrisChan
更新日期：2025/10/28
