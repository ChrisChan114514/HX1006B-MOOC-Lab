# lab_5_1 - 音乐播放器

## 项目概述

本实验设计了一个基于 FPGA 的音乐播放器，通过 PLL 锁相环分频、计数器和 ROM 存储器实现了简单的乐谱播放功能，能够按照预设的乐谱输出音乐信号到扬声器，并通过 LED 显示当前音符。

## Verilog程序设计

### 模块功能

`music_player` 模块实现了一个音乐播放器，具有以下特性：

- **时钟管理**：通过 PLL 锁相环将 50MHz 系统时钟分频为 1MHz 和 2KHz 时钟
- **节拍控制**：通过分频器产生 4Hz 节拍时钟，控制音符切换速度
- **乐谱存储**：使用 ROM 存储 138 个音符的乐谱数据
- **音调编码**：将 4 位音符编码转换为 11 位音调预置值
- **音频输出**：通过 D 触发器产生方波音频信号驱动扬声器
- **可视化指示**：通过 LED 显示当前演奏的音符（1-7）和音高标志

### 功能实现机制

#### 时钟分频系统

- **PLL 锁相环**：将 50MHz 系统时钟分频
  - c0 输出：1MHz（用于音频信号生成）
  - c1 输出：2KHz（用于节拍控制）
- **fdiv 分频器**：将 2KHz 时钟 500 分频产生 4Hz 节拍时钟
  - 计数周期：0~499（500 个时钟周期）
  - 输出脉冲：每 0.25 秒产生一个脉冲

#### 乐谱播放控制

- **cnt138t 计数器**：循环计数 0~138，作为 ROM 地址
  - 计数周期：139 个节拍（约 34.75 秒一轮）
  - 自动复位：计数到 138 后返回 0
  - 复位信号：支持 rst_n 外部复位
- **music ROM**：存储乐谱数据
  - 地址宽度：8 位（0~255）
  - 数据宽度：4 位（0~15）
  - 有效地址：0~138

#### 音调编码与输出

- **f_code 音调编码器**：将 4 位音符索引转换为音调参数
  - 音符 0：静音（TO=0x7FF）
  - 音符 1-7：低音 Do-Si（TO=0x305~0x55C）
  - 音符 8-15：高音 Do-Si（TO=0x582~0x6C0）
  - LED 显示：输出当前音符的简谱编号（0-7）
  - 高低音标志：H=0 表示低音，H=1 表示高音
- **speak 音频生成器**：产生音频脉冲
  - 输入：1MHz 时钟和 11 位音调预置值 TN
  - 输出：当 11 位计数器溢出时产生脉冲
  - 频率：由 TN 值决定，TN 越小频率越高
- **DFF 分频器**：将脉冲转换为方波
  - 输入：speak 模块的脉冲信号
  - 输出：翻转的方波信号驱动扬声器

### 端口说明

| 端口     | 方向   | 位宽 | 说明                                 |
| -------- | ------ | ---- | ------------------------------------ |
| clk      | input  | 1    | 50MHz 系统时钟                       |
| rst_n    | input  | 1    | 异步复位信号（低电平有效）           |
| speak    | output | 1    | 扬声器驱动信号（方波音频输出）       |
| high     | output | 1    | 音高指示（0=低音，1=高音）           |
| led[3:0] | output | 4    | LED 显示当前音符编号（0=静音，1-7） |

## ModelSim(Verilog TB代码仿真)

本工程可通过 ModelSim 进行仿真验证，观察音乐播放器各模块的工作时序。

### 仿真环境配置

- **时间单位**：`timescale 1ns/1ps`（时间刻度 1ns，时间精度 1ps）
- **时钟频率**：50MHz（周期 20ns）
- **仿真时长**：建议 40~50 秒以观察完整的乐曲播放周期

### 测试激励

1. **时钟生成**：产生 50MHz 连续时钟信号
2. **复位序列**：
   - 初始时刻 rst_n=0，复位系统
   - 100ns 后释放复位（rst_n=1）
3. **运行测试**：长时间仿真，观察音符切换和音频输出

### 观察信号

- **clk_4hz**：节拍时钟，每 0.25 秒一个脉冲，控制音符切换速度
- **cnt8**：乐谱地址计数器，0~138 循环计数
- **q**：当前音符编码（0~15）
- **TN**：音调预置值（0x305~0x6C0）
- **led**：LED 显示值，对应当前音符（0~7）
- **high**：音高标志位
- **speak**：扬声器输出方波信号

## FPGA板子硬件实验

生成 `.sof` 配置文件，下载到 FPGA 开发板进行硬件验证。

### 引脚绑定

#### 输入信号

| 信号  | FPGA引脚 | 硬件元件 | 说明                     |
| ----- | -------- | -------- | ------------------------ |
| clk   | E15      | 50MHz    | 系统时钟（板载晶振）     |
| rst_n | M1       | KEY1     | 复位信号（按下为低电平） |

#### 输出信号

| 信号   | FPGA引脚 | 硬件元件 | 说明                           |
| ------ | -------- | -------- | ------------------------------ |
| speak  | K10      | SPEAKER  | 扬声器驱动信号                 |
| high   | D15      | LED_H    | 音高指示灯（亮=高音，灭=低音） |
| led[0] | T10      | LED0     | 音符显示 LED 位 0              |
| led[1] | R9       | LED1     | 音符显示 LED 位 1              |
| led[2] | T9       | LED2     | 音符显示 LED 位 2              |
| led[3] | K8       | LED3     | 音符显示 LED 位 3              |

### 硬件测试步骤

1. **连接扬声器**

   - 确认 FPGA 开发板的扬声器接口连接正常
   - 或通过外部扬声器连接到 SPEAKER 引脚
2. **下载配置文件**

   - 在 Quartus II 中编译工程，生成 `.sof` 文件
   - 使用 USB Blaster 或其他下载器将配置文件下载到 FPGA
3. **复位测试**

   - 按下 KEY1（rst_n=0）复位系统
   - 系统复位后，计数器归零，准备从第一个音符开始播放
   - 松开 KEY1（rst_n=1），系统开始正常工作
4. **播放效果观察**

   - 正常工作后，扬声器开始播放预设的乐曲
   - LED 每隔约 0.25 秒变化一次，显示当前音符编号（二进制显示）
   - high 指示灯根据音高变化：低音时熄灭，高音时点亮
   - 乐曲播放完毕后自动循环
5. **时序验证**

   - 使用示波器或逻辑分析仪可以观测 speak 信号的方波频率
   - 节拍周期：约 0.25 秒（4Hz）
   - 音频频率：根据音符不同，频率在几百 Hz 到几千 Hz 之间
   - 完整播放周期：约 34.75 秒（138 个音符 × 0.25 秒）

ChrisChan
2025/10/28
